# ZapFS Minimal Cluster Configuration
# Single-manager setup with two file servers for testing and benchmarking
#
# Usage:
#   docker compose -f docker/docker-compose.minimal.yml up -d
#   ./scripts/benchmark.sh --host localhost:8082
#   go test -tags=integration -v ./integration/resiliency/...
#   docker compose -f docker/docker-compose.minimal.yml down -v

services:
  manager:
    image: zapfs:minimal
    command:
      - manager
      - --ip=0.0.0.0
      - --grpc_port=8050
      - --debug_port=8055
      - --admin_port=8060
      - --raft_dir=/data/raft
      - --raft_addr=manager:8051
      - --bootstrap
      - --node_id=manager
    environment:
      ZAPFS_IAM_MASTER_KEY: ${ZAPFS_IAM_MASTER_KEY:-c2VjcmV0LW1hc3Rlci1rZXktZm9yLWRldi1vbmx5IQ==}
    ports:
      - "8050:8050"
      - "8055:8055"
    volumes:
      - manager-data:/data
      - ../cmd/config:/etc/zapfs:ro
    networks:
      - zapfs-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8055/ready"]
      interval: 5s
      timeout: 3s
      retries: 6
      start_period: 10s

  metadata:
    image: zapfs:minimal
    command:
      - metadata
      - --ip=0.0.0.0
      - --http_port=8082
      - --grpc_port=8083
      - --debug_port=8085
      - --db_driver=mysql
      - --db_dsn=zapfs:zapfs@tcp(mysql:3306)/zapfs?parseTime=true
      - --manager_addr=manager:8050
    ports:
      - "8082:8082"  # S3 API endpoint
      - "8085:8085"  # Metrics
    volumes:
      - ../cmd/config:/config:ro
    networks:
      - zapfs-net
    depends_on:
      mysql:
        condition: service_healthy
      manager:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8085/ready"]
      interval: 5s
      timeout: 3s
      retries: 6
      start_period: 10s

  file-1:
    image: zapfs:minimal
    command:
      - file
      - --bind_addr=0.0.0.0:8081
      - --http_port=8080
      - --debug_port=8010
      - --index_path=/data/index
      - --node_id=file-1
      - --advertise_addr=file-1:8081
      - --manager_addr=manager:8050
      - --reconciliation_interval=30s
      - --reconciliation_grace_period=10s
    ports:
      - "8081:8081"
      - "8010:8010"  # Metrics
    volumes:
      - file-1-data:/data
    networks:
      - zapfs-net
    depends_on:
      manager:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8010/ready"]
      interval: 5s
      timeout: 3s
      retries: 6
      start_period: 10s

  file-2:
    image: zapfs:minimal
    command:
      - file
      - --bind_addr=0.0.0.0:8091
      - --http_port=8090
      - --debug_port=8011
      - --index_path=/data/index
      - --node_id=file-2
      - --advertise_addr=file-2:8091
      - --manager_addr=manager:8050
      - --reconciliation_interval=30s
      - --reconciliation_grace_period=10s
    ports:
      - "8091:8091"
      - "8011:8011"  # Metrics
    volumes:
      - file-2-data:/data
    networks:
      - zapfs-net
    depends_on:
      manager:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8011/ready"]
      interval: 5s
      timeout: 3s
      retries: 6
      start_period: 10s

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: zapfs
      MYSQL_USER: zapfs
      MYSQL_PASSWORD: zapfs
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - zapfs-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 5s
      timeout: 3s
      retries: 10
    command:
      - --default-authentication-plugin=mysql_native_password
      - --innodb-buffer-pool-size=512M
      - --innodb-log-file-size=256M
      - --max-connections=200

networks:
  zapfs-net:
    driver: bridge

volumes:
  manager-data:
  file-1-data:
  file-2-data:
  mysql-data:
